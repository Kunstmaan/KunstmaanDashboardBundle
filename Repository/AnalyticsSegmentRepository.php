<?php

namespace Kunstmaan\DashboardBundle\Repository;

use Doctrine\ORM\EntityRepository;

/**
 * AnalyticsSegmentRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class AnalyticsSegmentRepository extends EntityRepository
{
    /**
     * Get a segment
     *
     * @param int $id
     *
     * @return AnalyticsOverview|bool
     */
    public function deleteSegment($id)
    {
        $em = $this->getEntityManager();
        $qb = $em->createQueryBuilder();
        $qb->select('s')
            ->from('KunstmaanDashboardBundle:AnalyticsSegment', 's')
            ->where('s.id = :id')
            ->setParameter('id', $id);


        $results = $qb->getQuery()->getResult();
        if ($results) {
            $em->remove($results[0]);
            $em->flush();
        }
    }

    /**
     * Get a segment
     *
     * @param int id
     *
     * @return AnalyticsSegment
     */
    public function getSegment($id) {
        $qb = $this->getEntityManager()->createQueryBuilder();
        $qb->select('s')
            ->from('KunstmaanDashboardBundle:AnalyticsSegment', 's')
            ->where('s.id = :id')
            ->setParameter('id', $id);

        $results = $qb->getQuery()->getResult();
        if (sizeof($results) > 0) {
            return $results[0];
        } else {
            throw new \Exception('Unkown segment ID');
        }

        return false;
    }


    /**
     * Initialise a segment by adding new overviews if they don't exist yet
     *
     * @param AnalyticsSegment $segment
     * @param int $configId
     */
    public function initSegment($segment, $configId = false) {
        if (!count($segment->getOverviews()->toArray())) {
            $config =$this->getEntityManager()->getRepository('KunstmaanDashboardBundle:AnalyticsConfig')->find($configId);
            $this->getEntityManager()->getRepository('KunstmaanDashboardBundle:AnalyticsOverview')->addOverviews($config, $segment);
        }
    }

}
